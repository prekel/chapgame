\chapter{Программная реализация}

Здесь будет третья глава. \TODO

При разработке широко использовалось модульное программирования. При чём в некоторых частях программы использовались
продвинутые возможности языка модулей ML (реализованный в используемом OCaml), которые позволяют
отделять интерфейс модуля от его реализации,
параметризировать модули другими модулями (образуя функторы),
включать один модуль в другой, [\TODO]
производить инъекцию зависимостей и т.д [\TODO].

Например, функторы были использованы для того чтобы в реализации численного метода решения алгебраических уравнений
от конкретной реализации вещественных чисел. Это позволяет абстрагироваться от конкретной реализации вещественных,
что позволит на деле использовать разные реализации, например модуль для работы с числами двойной точности из стандартной библиотеки,
или самописную реализацию с использованием дробей на основе чисел двойной точности, или реализацию на основе длинной арифметики. \TODO

Была попытка использовать функторы и при реализации движка, но при чрезмерном их использовании код усложняется и для разработчика,
и для компилятора: слишком долгая компиляция, анализатор кода для интегрированной среды разработки потребляет слишком много памяти.
Поэтому сам движок разработан баз использования функторов: для представления вещественных чисел используются числа
с плавающей запятой двойной точности (в OCaml он называется <<float>>, когда в других языках может быть известен как <<double>>).

% Проект состоит из двух исполняемых подпроектов (т.е. таких, целью сборки которых является JavaScript скрипт или исполняемый файл): 
% клиентская часть и серверная часть; и нескольких библиотек: реализация численного метода решения алгебраических уравнений,
% символьные вычисления, движок, протокол

Проект состоит из нескольких подпроектов. На рисунке \TODO представлена диаграмма зависимостей между ними.
В таблице \TODO указано их место в исходном коде и соответствующий пункт ВКР.

\TODO Рисунок

\TODO Таблица

% т.е. все модули в программе, использующие вещественные числа, являются функторами, которые принимают
% модули с сигнатурой, описывающей вещественные числа. Это позволяет абстрагироваться от конкретной реализации вещественных,
% что позволит на деле использовать разные реализации, например модуль для работы с числами двойной точности из стандартной библиотеки,
% или самописную реализацию с использованием дробей на основе чисел двойной точности, или реализацию на основе длинной арифметики.
% Несмотря на то, что при реализации клиентской части используются числа с двойной точностью,
% главным плюсом такого решения остаётся потенциальная независимость от чисел двойной точности,
% что может быть полезно, особенно при использовании решателя алгебраических уравнений.

На рисунках \TODO и \TODO представлены диаграммы с функторами,
ромбовидная стрелка из \(F\) в \(S\) означает, что функтор \(F\) параметризируется модулем, имеющим сигнатуру \(S\);
треугольная стрелка из \(F\) в \(S\) означает, что функтор \(F\) возвращает модуль с сигнатурой \(S\).
Так как функторы можно назвать параметризированными модулями, функторы будут называться модулями.

\section{Реализация метода решения алгебраических уравнений}

Trtortnro. TRStrtrs. \TODO. Trtortnro. TRStrtrs. \TODO. Trtortnro. TRStrtrs. \TODO. Trtortnro. TRStrtrs. \TODO.  Trtortnro. TRStrtrs. \TODO.

\begin{figure}[H]
    \centering
    \includegraphics[width=10cm,trim={1cm 3cm 1cm 2cm},clip]{solver}
    \caption{Диаграмма модулей решателя алгебраических уравнений\label{fig:example}}
\end{figure}


Trtortnro. TRStrtrs. \TODO.  Trtortnro. TRStrtrs. \TODO.  Trtortnro. TRStrtrs. \TODO.  Trtortnro. TRStrtrs. \TODO.  Trtortnro. TRStrtrs. \TODO.  Trtortnro. TRStrtrs. \TODO.

\begin{centering}
    \begin{longtable}{|l|l|l|}
        \caption{Модули решателя алгебраических уравнений} \label{solvermodules}                                                                                                                                                                         \\

        \hline \multicolumn{1}{|c|}{\textbf{Название модуля}} & \multicolumn{1}{c|}{\textbf{Файлы}}                                                                                                      & \multicolumn{1}{c|}{\textbf{Расшифровка}}     \\ \hline
        \endfirsthead

        \multicolumn{3}{c}%
        {\hspace{-12.5cm}{Окончание таблицы \thetable} \vspace{1ex}}                                                                                                                                                                                     \\
        \hline \multicolumn{1}{|c|}{\textbf{Название модуля}} & \multicolumn{1}{c|}{\textbf{Файлы}}                                                                                                      & \multicolumn{1}{c|}{\textbf{Расшифровка}}     \\ \hline
        \endhead

        \multirow{2}{*}{Interval}                             & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/interval.ml}{lib/solver/interval.ml}                                     & \multirow{2}{*}{Промежуток}                   \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/interval\_intf.ml}{lib/solver/interval\_intf.ml}                         &                                               \\ \hline
        \multirow{2}{*}{Polynomial}                           & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/polynomial.ml}{lib/solver/polynomial.ml}                                 & \multirow{2}{*}{Многочлен}                    \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/polynomial\_intf.ml}{lib/solver/polynomial\_intf.ml}                     &                                               \\ \hline
        \multirow{2}{*}{Bisection}                            & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/bisection.ml}{lib/solver/bisection.ml}                                   & \multirow{2}{*}{Бисекция}                     \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/bisection\_intf.ml}{lib/solver/bisection\_intf.ml}                       &                                               \\ \hline
        \multirow{2}{*}{Polynomial\_equation}                 & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/polynomial\_equation.ml}{lib/solver/polynomial\_equation.ml}             & \multirow{2}{3.4cm}{Алгебраическое уравнение} \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/solver/polynomial\_equation\_intf.ml}{lib/solver/polynomial\_equation\_intf.ml} &                                               \\ \hline
    \end{longtable}
\end{centering}

\textbf{Промежуток}. Промежуток представлен алгебраическим типом данных
(алгебраический тип данных в функциональном программировании~-- размеченное объединение
других типов \cite{fprog-adt}),
у которого есть несколько конструкторов:

\begin{itemize}
    \item от одного вещественного числа до другого;
    \item от \(-\infty\) до заданного вещественного числа;
    \item от заданного вещественного числа до \(+\infty\);
    \item от \(-\infty\) до \(+\infty\) (вся числовая прямая);
    \item пустой промежуток.
\end{itemize}

Так же в этом модуле представлены функции для конвертации в кортеж, создания промежутка,
разбиения списка значений на промежутки, вычисления разности между правым и левым значением.

\textbf{Многочлен}. Многочлен представлен иммутабельным словарём, ключом которого является целое число (представляющее степень одночлена),
значением является вещественное число (представляющее коэффициент одночлена).
Предоставляет функции для создания многочлена из списка кортежей, для вычисления производной многочлена, для вычисления степени многочлена.
На рисунке \TODO представлена для примера реализация функции вычисления производной многочлена. Её можно прочитать так:
<<Пары ключ-значения из словаря, которым представлен многочлен, фильтруются так, чтобы остались только с ненулевой степенью,
и заодно коэффициент преобразовывается в коэффициент производной, умножаясь на степень; далее все ключи отображаются так, чтобы стали на единицу меньше
(при этом степень не может стать отрицательной, потому что многочлен нельзя создать с отрицательной степенью у одночлена,
а на предыдущем шаге мы исключили одночлен с нулевой степенью)>>.

\TODO Рисунок или лучше листинг

\textbf{Бисекция}. Этот модуль представляет функцию, принимающую другую функцию \(f(x)\), точность \(\varepsilon\)
и промежуток, на котором надо искать такой \(x\), что \(\left|f(x)\right| < \varepsilon\). Предполагается, что
функция монотонно возрастает или убывает на требуемом промежутке. Кроме самого метода бисекции, в ней реализован алгоритм,
позволяющий находить значения на бесконечном и полубесконечном промежутке, который описан в пункте~\ref{bisection}.

\textbf{Алгебраическое уравнение}. Этот модуль, используя все 3 вышеописанных, предоставляет главную функцию~-- принимающую
точность вычислений \(\varepsilon\) и многочлен \(P(x)\), и возвращающую список таких \(x\), что \(\left|P(x)\right| < \varepsilon\).
Иными словами, решает алгебраическое уравнение заданное многочленом с заданной точностью. На рисунке \TODO представлена её реализация, её можно прочитать следующим образом:
<<Вычисляется степень многочлена.
Если она нулевая или отрицательная, то вернуть пустой список.
Если равна единице, решить как линейное уравнение и преобразовать в список.
Если равна двум, решить как квадратное уравнение, учитывая точность.
Иначе, вычислить производную многочлена и найти её корни; разбить список корней на промежутки и методом бисекции найти корни на промежутках>>.

\TODO Рисунок или лучше листинг

Таким образом, реализован метод численного решения алгебраических уравнений, описанный в пункте~\ref{solvefourthdegree}.

\subsection{Тестирование}

\TODO

\section{Движок}\label{engine}

Архитектура движка имеет более плоскую и последовательную структуру, поэтому нет смысла приводить диаграмму.
В таблице \ref{enginemodules} представлены названия модулей и файлы модулей, далее описана их работа.

\begin{centering}
    \begin{longtable}{|l|l|l|}
        \caption{Модули движка} \label{enginemodules}                                                                                                                                                                                        \\

        \hline \multicolumn{1}{|c|}{\textbf{Название модуля}} & \multicolumn{1}{c|}{\textbf{Файлы}}                                                                                            & \multicolumn{1}{c|}{\textbf{Расшифровка}}   \\ \hline
        \endfirsthead

        \multicolumn{3}{c}%
        {\hspace{-12.5cm}{Окончание таблицы \thetable} \vspace{1ex}}                                                                                                                                                                         \\
        \hline \multicolumn{1}{|c|}{\textbf{Название модуля}} & \multicolumn{1}{c|}{\textbf{Файлы}}                                                                                            & \multicolumn{1}{c|}{\textbf{Расшифровка}}   \\ \hline
        \endhead

        \hline
        \endfoot

        \multirow{2}{*}{Body}                                 & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/body.ml}{lib/engine/body.ml}                                   & \multirow{2}{*}{Тело}                       \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/body.mli}{lib/engine/body.mli}                                 &                                             \\ \hline
        \multirow{2}{*}{Bodies}                               & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/bodies.ml}{lib/engine/bodies.ml}                               & \multirow{2}{*}{Тела}                       \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/bodies.mli}{lib/engine/bodies.mli}                             &                                             \\ \hline
        \multirow{2}{*}{Collision\_detection}                 & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/collision\_detection.ml}{lib/engine/collision\_detection.ml}   & \multirow{2}{2cm}{Обнаружение столкновений} \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/collision\_detection.mli}{lib/engine/collision\_detection.mli} &                                             \\ \hline
        \multirow{2}{*}{Collision\_handle}                    & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/collision\_handle.ml}{lib/engine/collision\_handle.ml}         & \multirow{2}{*}{Обработка ударов}           \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/collision\_handle.mli}{lib/engine/collision\_handle.mli}       &                                             \\ \hline
        \multirow{2}{*}{Action}                               & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/action.ml}{lib/engine/action.ml}                               & \multirow{2}{*}{Действие}                   \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/action.mli}{lib/engine/action.mli}                             &                                             \\ \hline
        \multirow{2}{*}{Line}                                 & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/line.ml}{lib/engine/line.ml}                                   & \multirow{2}{*}{Линия}                      \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/line.mli}{lib/engine/line.mli}                                 &                                             \\ \hline
        \multirow{2}{*}{Model}                                & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/model.ml}{lib/engine/model.ml}                                 & \multirow{2}{*}{Модель}                     \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/model.mli}{lib/engine/model.mli}                               &                                             \\ \hline
        \multirow{2}{*}{Point}                                & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/point.ml}{lib/engine/point.ml}                                 & \multirow{2}{*}{Точка}                      \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/point.mli}{lib/engine/point.mli}                               &                                             \\ \hline
        \multirow{2}{*}{Rule}                                 & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/rule.ml}{lib/engine/rule.ml}                                   & \multirow{2}{*}{Правило}                    \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/rule.mli}{lib/engine/rule.mli}\TODO                            &                                             \\ \hline
        \multirow{2}{*}{Scene}                                & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/scene.ml}{lib/engine/scene.ml}                                 & \multirow{2}{*}{Сцена}                      \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/scene.mli}{lib/engine/scene.mli}\TODO                          &                                             \\ \hline
        \multirow{2}{*}{Scenes}                               & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/scenes.ml}{lib/engine/scenes.ml}                               & \multirow{2}{*}{Сцены}                      \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/scenes.mli}{lib/engine/scenes.mli}                             &                                             \\ \hline
        \multirow{2}{*}{Values}                               & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/values.ml}{lib/engine/values.ml}                               & \multirow{2}{*}{Значения}                   \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/values.mli}{lib/engine/values.mli}                             &                                             \\ \hline
        \multirow{2}{*}{Engine}                               & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/engine.ml}{lib/engine/engine.ml}                               & \multirow{2}{*}{Движок}                     \\*
                                                              & \href{https://github.com/prekel/chapgame/blob/master/lib/engine/engine.mli}{lib/engine/engine.mli}                             &                                             \\ \hline
    \end{longtable}
\end{centering}

\TODO

\subsection{Символьные вычисления}\label{expr}

\TODO

\section{Клиентская часть, одиночный режим}

\TODO

\section{Серверная часть}

\subsection{Получение отличий модели}\label{model-diff-implementation}

\TODO

\section{Клиентская часть, многопользовательский режим}

\TODO
